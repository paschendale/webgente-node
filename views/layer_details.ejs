<%- include('partials/admin/header.ejs') %> 
<div>

    <!-- Notas sobre o comportamento da adição e edição de Layers nesta página
    
        Toda vez que esta página for chamada como 'EDIÇÃO' ela deve verificar se 
        a lista de campos armazenada em Layer.fields corresponde com a lista de 
        campos dada pela rota /describeLayer. Caso negativo, ela deve informar
        ao administrador do problema!

        Eventuais problemas podem surgir com essa diferença entre os campos armazenados
        e os campos no Geoserver, neste caso, basta o administrador abrir a camada em
        edição e recarregar os campos para adicionar os novos

        TODO: Ao dar reload nos campos a tabela deverá apenas adicionar campos inexistentes
        de forma que a configuração anterior não seja prejudicada.

        TODO: Permitir reordenar os campos para exibição nas interfaces
    
    -->

    <div class="container">
        <!--Início do fomrulário-->
        <div class="container shadow-sm" id="container-form-layerdetails">
                <% if (edit) { %> <!-- Switch entre rotas do modo de edição e criação de camadas -->
                    <form action="/layers/edit/<%=id%>" onsubmit="return validateForm()" method="POST">
                <% } else { %>
                    <form action="/layers/add" onsubmit="return validateForm()" method="POST">
                <% } %>
                <h3>Adicionando camadas:</h3>
                <hr>
                <div class="row">
                    <div class="col">
                        <label for="layerName"><strong>Nome de exibição da camada no menu de camadas:</strong></label>
                        <div class="form-group">
                            <input type="text" class="form-control" id="layerName" name="layerName" placeholder="Nome de Exibição da Camada">
                        </div>
                    </div>
                    <div class="col">
                        <label for="group"><strong>Grupo da camada no menu de camadas:</strong></label>
                        <div class="form-group">
                            <input type="text" class="form-control" id="group" name="group" placeholder="Grupo da Camada">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label for="layer"><strong>Nome da camada no servidor de mapas:</strong></label>
                        <div class="form-group">
                            <input type="text" class="form-control" id="layer" name="layer" placeholder="workspace:camada">
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="layer-type"><strong>Tipo de Camada:</strong></label>
                            <div class="form-check" id="layer-type">
                                <input class="form-check-input" type="radio" name="type" id="basemap" value="1">
                                <label class="form-check-label" for="basemap">
                                    Camada Base
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="type" id="overlay" value="2" checked>
                                <label class="form-check-label" for="overlay">
                                    Camada de Sobreposição
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            <div class="row">
                <div class="col">
                        <label for="host"><strong>Endereço do servidor de mapas:</strong></label>
                        <div class="form-group">
                            <input type="text" class="form-control" id="host" name="host" placeholder="http://localhost/geoserver/gianetti/wms?">
                        </div>
                </div>
                <div class="col">
                        <div class="form-group">
                            <label for="layer-type"><strong>Camada Padrão?</strong></label>
                            <div class="form-check" id="default-layer">
                                <input class="form-check-input" type="radio" name="defaultBaseLayer" id="true" value="1">
                                <label class="form-check-label" for="true">
                                    Sim
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="defaultBaseLayer" id="false" value="2" checked>
                                <label class="form-check-label" for="false">
                                    Não
                                </label>
                            </div>
                        </div>
                </div>
            </div>   
            <div class="row">
                    <div class="col">
                        <label for="host"><strong>Link para Metadados:</strong></label>
                        <div class="form-group">
                            <input type="text" class="form-control" id="metadata" name="metadata" placeholder="/metadata/CAD_Lote.html">
                        </div>
                    </div>
                </div>       
                <button type="button" id="load-layer-attributes" class="btn btn-dark" onClick="loadLayerAttributes()">
                    <span class="fas fa-sync-alt"></span>  Carregar atributos da camada
                </button>
        </div>
        <!--Fim do formulário-->
        <hr>
        <div id="attributes-div" class="collapse">
            <table 
                id="attributes-table"
                class="table table-striped" 
                data-toggle="table" 
                data-pagination="false"> 
                <thead class="thead-dark">
                    <tr>
                    <th data-field="name">Nome do Atributo</th>
                    <th data-field="allowed" data-halign="center">Permitido</th>
                    <th data-field="queryable" data-halign="center">Pesquisável</th>
                    <th data-field="alias" data-halign="center">Apelido</th>
                    <th data-field="type" data-halign="center">Tipo</th>
                </thead>
            </table>
        </div>

        <!-- Campos ocultos para construção do formato de envio à base de dados -->
        <div class="form-group">
            <input type="hidden" class="form-control" id="fields" name="fields" placeholder="fields">
        </div>
        <div class="form-group">
            <input type="hidden" class="form-control" id="allowedFields" name="allowedFields" placeholder="allowedFields">
        </div>
        <div class="form-group">
            <input type="hidden" class="form-control" id="queryFields" name="queryFields" placeholder="queryFields">
        </div>
        <div class="form-group">
            <input type="hidden" class="form-control" id="fieldAlias" name="fieldAlias" placeholder="fieldAlias">
        </div>
        <div class="form-group">
            <input type="hidden" class="form-control" id="fieldType" name="fieldType" placeholder="fieldAlias">
        </div>
        <div id="align5">
        <button type="submit" class="btn btn-dark">Salvar</button>
        </div>
        </form>
    </div>   

    <script>

        var loadedAttributes = 0; // Estado da tabela de atributos. 0: nao carregado, 1: carregada

        var edit = false; // Habilita ou nao carregamento de fieldAlias, queryFields e allowedFields ao finalizar carregamento da tabela

        async function loadLayerAttributes(){

            loadedAttributes = 1;

            host = $('#host').val()
            layer = $('#layer').val()

            $.get("/describeLayer/" + layer + '/' + encodeURIComponent(host))
            .done(data => {   
                data = JSON.parse(data);          
                if ($('#basemap').is(':checked')) {
                    $("#attributes-table").html('Camadas base não possuem atributos.')
                    $("#attributes-div").collapse('show')
                    return null
                } else if(data.featureTypes != undefined) {
                    createAttributesTable(data.featureTypes[0].properties);
                } else {
                    alert('Não existe a camada ' + layer + ' no host ' + host)
                }
            })
            .fail(function() {
                alert('Não foi possível recuperar a lista de atributos da camada');
            });
        }

        function createAttributesTable(properties) {
            n = 0
            fieldsString = [];
            typeString = [];
            $("#attributes-table").bootstrapTable('destroy').bootstrapTable()
            for (property of properties) {
                data = {
                    name: property.name,
                    allowed: '<div class="form-group" id="align3"><input class="form-check-input allowed-col" type="checkbox" value="true" id="allowed-field-'+n+'"></div>',
                    queryable: '<div class="form-group" id="align4"><input class="form-check-input queryable-col" type="checkbox" value="true" id="queryable-field-'+n+'"></div>',
                    alias: '<div class="form-group" id="align5"><input type="text" class="form-control alias-col" value="" id="alias-'+n+'"></div>',
                    type: property.localType
                }
                fieldsString.push(property.name) // Criando o campo Fields
                typeString.push(property.localType) // Criando o campo Type
                $("#attributes-table").bootstrapTable('append', data)
                n++;
                if (n == properties.length && edit) { // Isso é uma bela gambiarra pra chamar o preenchimento da tabela caso o modo for edição e quando terminar os .append
                    fillTableForEditing();
                }
            }

            $('#fields').val('').val(fieldsString);
            $('#fieldType').val('').val(typeString);
            $("#attributes-div").collapse('show');
        }

        function validateForm(){ // Função para validar dados de entrada antes de envia-los ao backend

            // Recupera todos os campos com id #alias-n, #queryable-n e #enabled-n, constrói strings e submete no input em um campo com tipo 'hidden'

            fillHiddenForms();            
            
            // Check se as strings de fields, queryFields, allowedFields e fieldAlias possuem mesmo comprimento

            fieldLength = [
                $('#queryFields').val().split(',').length,
                $('#fieldAlias').val().split(',').length,
                $('#allowedFields').val().split(',').length,
                $('#fields').val().split(',').length,
                $('#fieldType').val().split(',').length
            ]

            if(!fieldLength.every( (val, i, arr) => val === arr[0] )){
                alert('Há algum erro na entrada dos dados, por favor, recarregue a página e reinsira os dados novamente')
                return false;
            }

            // TODO: Deixar bonito essa validação com JS colorindo os campos errados

            if (loadedAttributes == 1 || $('#basemap').is(':checked')) { // Verifica se foram carregados os atributos da camada antes de salva-la ou se a camada é um basemap
                return true;
            } else {
                alert('Carregue os atributos da camada antes de salva-la!')
                return false;
            }

        }

        function fillHiddenForms(){

            /*  O campo fields é preenchido na chamada da tabela em createAttributeTable */

            alias = $('.alias-col')
            allowed = $('.allowed-col')
            queryable = $('.queryable-col')

            aliasString = [];
            queryableString = [];
            allowedString = [];

            for (i = 0; i < alias.length; i++){
                aliasString.push(alias[i].value)
            }

            for (i = 0; i < allowed.length; i++){
                if(allowed[i].checked){
                    allowedString.push('true')
                } else {
                    allowedString.push('false')
                }                
            }

            for (i = 0; i < queryable.length; i++){
                if(queryable[i].checked){
                    queryableString.push('true')
                } else {
                    queryableString.push('false')
                }
            }

            $('#fieldAlias').val('').val(aliasString);
            $('#allowedFields').val('').val(allowedString);
            $('#queryFields').val('').val(queryableString);

        }
    </script>

    <!-- A variável edit é passada como true se o modo for edição -->
    <% if (edit) { %> 

    <script>

        var edit = true // Habilita o preenchimento dos campos para edição

        $(document).ready(loadLayerDataForEditing())

        function loadLayerDataForEditing(){    
            $('#layerName').val("<%=layerName%>")
            $('#group').val("<%=group%>")
            $('#layer').val("<%=layer%>")
            $('#host').val("<%=host%>")
            $('#metadata').val("<%=metadata%>")
            
            if("<%=type%>" == 1) {
                $('input:radio[name=type][value=1]').click();
            }
            if("<%=defaultBaseLayer%>" == 1) {
                $('input:radio[name=defaultBaseLayer][value=1]').click();
            }  

            loadLayerAttributes() // Carrega a tabela de atributos da Layer
                       
        }

        function fillTableForEditing() {
            allowedFields = "<%=allowedFields%>".split(',')
            queryFields = "<%=queryFields%>".split(',')
            fieldAlias = "<%=fieldAlias%>".split(',')

            alias = $('.alias-col')
            allowed = $('.allowed-col')
            queryable = $('.queryable-col')
            
            for (i = 0; i < allowedFields.length; i++) {
                if (allowedFields[i] == 'true') {
                    allowed[i].checked = true
                }
            }

            for (i = 0; i < queryable.length; i++) {
                if (queryFields[i] == 'true') {
                    queryable[i].checked = true
                }
            }

            for (i = 0; i < alias.length; i++) {
                alias[i].value = fieldAlias[i]
            }
        }
    </script>
       
    <% } %>

</div>
<%- include('partials/admin/footer.ejs') %> 